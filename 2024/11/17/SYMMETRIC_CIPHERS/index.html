<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Cryptohack-SYMMETRIC CIPHERS | Q1uJu's Blog</title><meta name="author" content="Q1uJu"><meta name="copyright" content="Q1uJu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Cryptohack-SYMMETRIC CIPHERSSYMMETRIC CIPHERS对称密钥密码是使用相同密钥加密和解密数据的算法。目标是使用短密钥安全有效地发送长消息。 最著名的对称密钥密码是2001年标准化的高级加密标准（AES）。它如此普遍，以至于现代处理器甚至包含了执行AES操作的特殊指令集。这里的第一系列挑战将指导您了解AES的内部工作原理，向您展示其单独的组件如何协同工作，使">
<meta property="og:type" content="article">
<meta property="og:title" content="Cryptohack-SYMMETRIC CIPHERS">
<meta property="og:url" content="http://q1uju.cc/2024/11/17/SYMMETRIC_CIPHERS/index.html">
<meta property="og:site_name" content="Q1uJu&#39;s Blog">
<meta property="og:description" content="Cryptohack-SYMMETRIC CIPHERSSYMMETRIC CIPHERS对称密钥密码是使用相同密钥加密和解密数据的算法。目标是使用短密钥安全有效地发送长消息。 最著名的对称密钥密码是2001年标准化的高级加密标准（AES）。它如此普遍，以至于现代处理器甚至包含了执行AES操作的特殊指令集。这里的第一系列挑战将指导您了解AES的内部工作原理，向您展示其单独的组件如何协同工作，使">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://q1uju.cc/assets/background.png">
<meta property="article:published_time" content="2024-11-17T03:30:53.436Z">
<meta property="article:modified_time" content="2024-11-17T03:32:35.728Z">
<meta property="article:author" content="Q1uJu">
<meta property="article:tag" content="CTF-Crypto&#x2F;Misc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://q1uju.cc/assets/background.png"><link rel="shortcut icon" href="/assets/favicon.ico"><link rel="canonical" href="http://q1uju.cc/2024/11/17/SYMMETRIC_CIPHERS/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Cryptohack-SYMMETRIC CIPHERS',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-17 11:32:35'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/assets/fac4.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Galley</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/assets/background.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Q1uJu's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Cryptohack-SYMMETRIC CIPHERS</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> Galley</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Cryptohack-SYMMETRIC CIPHERS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2024-11-17T03:30:53.436Z" title="Created 2024-11-17 11:30:53">2024-11-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer">

<h1 id="Cryptohack-SYMMETRIC-CIPHERS"><a href="#Cryptohack-SYMMETRIC-CIPHERS" class="headerlink" title="Cryptohack-SYMMETRIC CIPHERS"></a>Cryptohack-SYMMETRIC CIPHERS</h1><h2 id="SYMMETRIC-CIPHERS"><a href="#SYMMETRIC-CIPHERS" class="headerlink" title="SYMMETRIC CIPHERS"></a>SYMMETRIC CIPHERS</h2><p>对称密钥密码是使用相同密钥加密和解密数据的算法。目标是使用短密钥安全有效地发送长消息。</p>
<p>最著名的对称密钥密码是2001年标准化的高级加密标准（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>）。它如此普遍，以至于现代处理器甚至包含了执行AES操作的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/AES_instruction_set">特殊指令集</a>。这里的第一系列挑战将指导您了解AES的内部工作原理，向您展示其单独的组件如何协同工作，使其成为一个安全的密码。到最后，您将构建自己的AES解密代码！</p>
<p>我们可以将对称密钥密码分为两类，分组密码和流密码。分组密码将明文分解为固定长度的块，并将每个块与密钥一起通过加密函数发送。同时，流密码通过将伪随机密钥流与数据进行异或运算，一次加密一个字节的明文。AES是一种分组密码，但可以使用CTR等操作模式转换为流密码。</p>
<p>分组密码仅指定如何加密和解密单个块，必须使用一种<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">操作模式</a>将密码应用于较长的消息。这就是现实世界的实现经常失败的地方，因为开发人员不理解使用特定模式的微妙含义。在剩下的挑战中，您将攻击各种模式的常见滥用。</p>
<h3 id="How-AES-WORKS"><a href="#How-AES-WORKS" class="headerlink" title="How AES WORKS"></a>How AES WORKS</h3><h4 id="Keyed-Permutations"><a href="#Keyed-Permutations" class="headerlink" title="Keyed Permutations"></a>Keyed Permutations</h4><p>AES和所有好的分组密码一样，执行“密钥置换”。这意味着它将每个可能的输入块映射到一个唯一的输出块，并使用密钥确定要执行的置换。</p>
<blockquote>
<p>“块”只是指固定数量的比特或字节，可以表示任何类型的数据。AES处理一个块并输出另一个块。我们将具体讨论AES的变体，它适用于128位（16字节）块和128位密钥，称为AES-128。</p>
</blockquote>
<p>使用相同的密钥，可以反向执行置换，将输出块映射回原始输入块。重要的是，输入和输出块之间有一对一的对应关系，否则我们将无法依赖密文解密回我们开始时的明文。</p>
<p>题目：一对一对应关系的数学术语是什么？</p>
<blockquote>
<p>bijection</p>
</blockquote>
<h4 id="Resisting-Bruteforce"><a href="#Resisting-Bruteforce" class="headerlink" title="Resisting Bruteforce"></a>Resisting Bruteforce</h4><p>如果分组密码是安全的，那么攻击者就没有办法将AES的输出与比特的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Pseudorandom_permutation">随机排列</a>区分开来。此外，没有比简单地强制执行每个可能的密钥更好的方法来撤消排列。这就是为什么学者们认为，如果他们能找到一种比粗暴破解密钥所需步骤更少的攻击，即使这种攻击实际上是不可行的，那么从理论上讲，密码就是“被攻破的”。</p>
<blockquote>
<p>强制执行128位密钥空间有多难？<a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/a/48669">有人估计</a>，如果你用整个比特币挖矿网络的力量来对抗AES-128密钥，破解密钥将需要100多倍于宇宙年龄的时间。</p>
</blockquote>
<p>事实证明，对AES的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Biclique_attack">攻击</a>比bruteforce好，但只是稍微好一点——它将AES-128的安全级别降低到126.1位，并且已经8年多没有改进了。鉴于128位提供的巨大“安全裕度”，以及尽管进行了广泛的研究，但仍缺乏改进，因此它不被认为是对AES安全的可信风险。但是，是的，从非常狭义的意义上讲，它“打破”了AES。</p>
<p>最后，虽然量子计算机有可能通过<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shor%27s_algorithm">Shor的算法</a>完全破解RSA等流行的公钥密码系统，但据认为，通过<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Grover's_algorithm">Grover的算法</a>，它们只能将对称密码系统的安全级别降低一半。这就是为什么人们建议使用AES-256的原因之一，尽管它的性能较差，因为它在量子未来仍然可以提供非常足够的128位安全性。</p>
<p>题目：针对AES的最佳单密钥攻击的名称是什么？</p>
<blockquote>
<p>biclique</p>
</blockquote>
<h4 id="Structure-of-AES"><a href="#Structure-of-AES" class="headerlink" title="Structure of AES"></a>Structure of AES</h4><p>为了实现在没有密钥的情况下无法反转的密钥置换，AES对输入应用了大量的ad-hoc混合操作。这与RSA等公钥密码系统形成鲜明对比，后者基于优雅的独立数学问题。AES的优雅程度要低得多，但速度非常快。</p>
<p>在较高层次上，AES-128从“密钥编排”开始，然后在一个状态矩阵上运行10轮。起始状态矩阵就是我们想要加密的明文块，表示为4x4字节矩阵。在10轮的过程中，状态矩阵被多次可逆变换反复修改。</p>
<blockquote>
<p>每个转换步骤都有一个明确的目的，基于Claude Shannon在20世纪40年代建立的安全密码的理论性质。在接下来的挑战中，我们将更仔细地研究其中的每一个步骤。</p>
</blockquote>
<p>以下是AES加密阶段的概述：</p>
<ol>
<li><p><strong>密钥扩展</strong>&#x2F;密钥编排</p>
<p>从128位密钥中，导出11个单独的128位“轮密钥”：一个用于每个轮密钥添加步骤。</p>
</li>
<li><p><strong>初始密钥添加</strong></p>
<p>轮密钥添加 - 第一轮密钥的字节与状态矩阵的字节进行XOR运算。</p>
</li>
<li><p><strong>循环</strong> - 此阶段循环10次，包括9个主循环和一个“最后一轮”</p>
<ol>
<li><strong>字节代换</strong> - 根据查找表（”S-box”），每个规定的字节被替换为不同的字节。</li>
<li><strong>行移位</strong> - 状态矩阵的最后三行被转置——在一列、两列或三列上移动。</li>
<li><strong>列混淆</strong> - 对状态矩阵的列执行矩阵乘法，将每列中的四个字节组合在一起。这在最后一轮中被跳过。</li>
<li><strong>轮密钥添加</strong> - 当前轮密钥的字节与状态矩阵的字节进行XOR运算。</li>
</ol>
</li>
</ol>
<p>题目：代码中包括一个bytes2matrix函数，用于将初始明文块转换为状态矩阵。编写一个matrix2bytes函数将该矩阵转换回字节，并将生成的明文作为flag提交。</p>
<p>源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># matrix.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes2matrix</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 16-byte array into a 4x4 matrix.  &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">list</span>(text[i:i+<span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(text), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    ????</span><br><span class="line"></span><br><span class="line">matrix = [</span><br><span class="line">    [<span class="number">99</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">112</span>],</span><br><span class="line">    [<span class="number">116</span>, <span class="number">111</span>, <span class="number">123</span>, <span class="number">105</span>],</span><br><span class="line">    [<span class="number">110</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">116</span>],</span><br><span class="line">    [<span class="number">114</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">125</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(matrix2bytes(matrix))</span><br></pre></td></tr></table></figure>

<p>EXP:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> matrix:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            message += <span class="built_in">str</span>(<span class="built_in">hex</span>(i[j])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(message, <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">matrix = [</span><br><span class="line">    [<span class="number">99</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">112</span>],</span><br><span class="line">    [<span class="number">116</span>, <span class="number">111</span>, <span class="number">123</span>, <span class="number">105</span>],</span><br><span class="line">    [<span class="number">110</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">116</span>],</span><br><span class="line">    [<span class="number">114</span>, <span class="number">105</span>, <span class="number">120</span>, <span class="number">125</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(matrix2bytes(matrix))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;inmatrix&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Round-Keys"><a href="#Round-Keys" class="headerlink" title="Round Keys"></a>Round Keys</h4><p>现在我们将跳过<strong>密钥扩展</strong>阶段的细节。关键在于，它接收我们的16字节密钥，并从我们的初始密钥中生成11个4x4矩阵，称为“轮密钥”。这些轮密钥允许AES从我们提供的单个密钥中获得额外的里程。</p>
<p>下一个<strong>初始密钥添加</strong>阶段有一个<em>轮密钥添加</em>步骤。<em>轮密钥添加</em>步骤很简单：它将当前状态矩阵与当前轮密钥进行异或。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241108102447525.png" alt="image-20241108102447525"></p>
<p>轮密钥添加也是每一轮的最后一步。<em>轮密钥添加</em>使AES成为一种“密钥置换”，而不仅仅是一种置换。这是AES中唯一将密钥混合到状态矩阵中的部分，但对于决定发生的置换至关重要。</p>
<p>正如您在之前的挑战中所看到的，如果您知道密钥，XOR是一个很容易反转的操作，但如果您不知道密钥，则很难撤消。现在想象一下，尝试恢复用11个不同密钥XOR的明文，并且在每个XOR操作之间用一系列替换和转置密码严重混淆。AES就是这么做的！我们将在接下来的几次挑战中看到这种联合的有效性。</p>
<p>题目：完成<code>add_round_key</code>函数，然后使用<code>matrix2bytes</code>函数获取下一个flag。</p>
<p>EXP:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> matrix:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            message += <span class="built_in">str</span>(<span class="built_in">hex</span>(i[j])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(message, <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_round_key</span>(<span class="params">s, k</span>):</span><br><span class="line">    new_state = [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_state[i][j] = s[i][j] ^ k[i][j]</span><br><span class="line">    <span class="keyword">return</span> new_state</span><br><span class="line"></span><br><span class="line">state = [</span><br><span class="line">    [<span class="number">206</span>, <span class="number">243</span>, <span class="number">61</span>, <span class="number">34</span>],</span><br><span class="line">    [<span class="number">171</span>, <span class="number">11</span>, <span class="number">93</span>, <span class="number">31</span>],</span><br><span class="line">    [<span class="number">16</span>, <span class="number">200</span>, <span class="number">91</span>, <span class="number">108</span>],</span><br><span class="line">    [<span class="number">150</span>, <span class="number">3</span>, <span class="number">194</span>, <span class="number">51</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">round_key = [</span><br><span class="line">    [<span class="number">173</span>, <span class="number">129</span>, <span class="number">68</span>, <span class="number">82</span>],</span><br><span class="line">    [<span class="number">223</span>, <span class="number">100</span>, <span class="number">38</span>, <span class="number">109</span>],</span><br><span class="line">    [<span class="number">32</span>, <span class="number">189</span>, <span class="number">53</span>, <span class="number">8</span>],</span><br><span class="line">    [<span class="number">253</span>, <span class="number">48</span>, <span class="number">187</span>, <span class="number">78</span>],</span><br><span class="line">]</span><br><span class="line">matrix = add_round_key(state, round_key)</span><br><span class="line"><span class="built_in">print</span>(matrix2bytes(matrix))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;r0undk3y&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Confusion-through-Substitution"><a href="#Confusion-through-Substitution" class="headerlink" title="Confusion through Substitution"></a>Confusion through Substitution</h4><p>每个AES轮的第一步是<em>字节替换</em>。这一步包含获取状态矩阵的每个字节，并将其替换为预设16x16查找表中的不同字节。查找表被称为“替换盒”或简称为“S盒，乍一看可能会令人困惑。让我们把它分解一下。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241108105347799.png" alt="image-20241108105347799"></p>
<p>1945年，美国数学家Claude Shannon发表了一篇关于信息论的开创性论文。它将“混淆”确定为安全密码的基本属性。“混淆”意味着密文和密钥之间的关系应该尽可能复杂。只要有一个密文，就不应该有办法了解任何关于密钥的信息。</p>
<p>如果密码的混淆性较差，则可以将密文、密钥和明文之间的关系表示为线性函数。例如，在凯撒密码中，<code>ciphertext = plaintext + key</code>。这是一个显而易见的关系，很容易逆转。更复杂的线性变换可以使用高斯消元等技术来解决。即使是低阶多项式，例如<code>x^4 + 51x^3 + x</code>这样的方程，也可以使用<a target="_blank" rel="noopener" href="https://math.stackexchange.com/a/1078515">代数方法</a>有效地求解。然而，多项式的次数越高，通常就越难求解——它只能用越来越多的线性函数来近似。</p>
<p>S盒的主要目的是以一种不易被线性函数近似的方式转换输入。S盒的目标是高<em>非线性</em>，虽然AES的S盒并不完美，但它非常接近。S盒中的快速查找是对输入字节执行极其非线性函数的快捷方式。该函数涉及在<a target="_blank" rel="noopener" href="https://www.samiam.org/galois.html">伽罗瓦域 2**8</a>中取模逆，然后应用仿射变换，该变换已被调整以最大程度地混淆。表达函数的最简单方法是通过以下高次多项式：<br>$$<br>f(x) &#x3D; 05x^{fe} + 09x^{fd} + f9x^{fb} + 25x^{f7} + f4x^{ef} + 01x^{df} + b5x^{bf} + 9fx^{7f} + 63<br>$$<br>为了制作S盒，该函数已根据从0x00到0xff的所有输入值以及查找表中的输出进行了计算。</p>
<p>题目：实现<code>sub_bytes</code>函数，通过逆S盒传递状态矩阵，然后将其转换为字节以获得flag。</p>
<p>EXP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> matrix:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            message += <span class="built_in">str</span>(<span class="built_in">hex</span>(i[j])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(message, <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">s_box = (</span><br><span class="line">    <span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>,</span><br><span class="line">    <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">    <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>,</span><br><span class="line">    <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>,</span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>,</span><br><span class="line">    <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>,</span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>,</span><br><span class="line">    <span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>,</span><br><span class="line">    <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>,</span><br><span class="line">    <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>,</span><br><span class="line">    <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>,</span><br><span class="line">    <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>,</span><br><span class="line">    <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">inv_s_box = (</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x09</span>, <span class="number">0x6A</span>, <span class="number">0xD5</span>, <span class="number">0x30</span>, <span class="number">0x36</span>, <span class="number">0xA5</span>, <span class="number">0x38</span>, <span class="number">0xBF</span>, <span class="number">0x40</span>, <span class="number">0xA3</span>, <span class="number">0x9E</span>, <span class="number">0x81</span>, <span class="number">0xF3</span>, <span class="number">0xD7</span>, <span class="number">0xFB</span>,</span><br><span class="line">    <span class="number">0x7C</span>, <span class="number">0xE3</span>, <span class="number">0x39</span>, <span class="number">0x82</span>, <span class="number">0x9B</span>, <span class="number">0x2F</span>, <span class="number">0xFF</span>, <span class="number">0x87</span>, <span class="number">0x34</span>, <span class="number">0x8E</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0xC4</span>, <span class="number">0xDE</span>, <span class="number">0xE9</span>, <span class="number">0xCB</span>,</span><br><span class="line">    <span class="number">0x54</span>, <span class="number">0x7B</span>, <span class="number">0x94</span>, <span class="number">0x32</span>, <span class="number">0xA6</span>, <span class="number">0xC2</span>, <span class="number">0x23</span>, <span class="number">0x3D</span>, <span class="number">0xEE</span>, <span class="number">0x4C</span>, <span class="number">0x95</span>, <span class="number">0x0B</span>, <span class="number">0x42</span>, <span class="number">0xFA</span>, <span class="number">0xC3</span>, <span class="number">0x4E</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x2E</span>, <span class="number">0xA1</span>, <span class="number">0x66</span>, <span class="number">0x28</span>, <span class="number">0xD9</span>, <span class="number">0x24</span>, <span class="number">0xB2</span>, <span class="number">0x76</span>, <span class="number">0x5B</span>, <span class="number">0xA2</span>, <span class="number">0x49</span>, <span class="number">0x6D</span>, <span class="number">0x8B</span>, <span class="number">0xD1</span>, <span class="number">0x25</span>,</span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0xF8</span>, <span class="number">0xF6</span>, <span class="number">0x64</span>, <span class="number">0x86</span>, <span class="number">0x68</span>, <span class="number">0x98</span>, <span class="number">0x16</span>, <span class="number">0xD4</span>, <span class="number">0xA4</span>, <span class="number">0x5C</span>, <span class="number">0xCC</span>, <span class="number">0x5D</span>, <span class="number">0x65</span>, <span class="number">0xB6</span>, <span class="number">0x92</span>,</span><br><span class="line">    <span class="number">0x6C</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x50</span>, <span class="number">0xFD</span>, <span class="number">0xED</span>, <span class="number">0xB9</span>, <span class="number">0xDA</span>, <span class="number">0x5E</span>, <span class="number">0x15</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0xA7</span>, <span class="number">0x8D</span>, <span class="number">0x9D</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0xD8</span>, <span class="number">0xAB</span>, <span class="number">0x00</span>, <span class="number">0x8C</span>, <span class="number">0xBC</span>, <span class="number">0xD3</span>, <span class="number">0x0A</span>, <span class="number">0xF7</span>, <span class="number">0xE4</span>, <span class="number">0x58</span>, <span class="number">0x05</span>, <span class="number">0xB8</span>, <span class="number">0xB3</span>, <span class="number">0x45</span>, <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0x1E</span>, <span class="number">0x8F</span>, <span class="number">0xCA</span>, <span class="number">0x3F</span>, <span class="number">0x0F</span>, <span class="number">0x02</span>, <span class="number">0xC1</span>, <span class="number">0xAF</span>, <span class="number">0xBD</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x13</span>, <span class="number">0x8A</span>, <span class="number">0x6B</span>,</span><br><span class="line">    <span class="number">0x3A</span>, <span class="number">0x91</span>, <span class="number">0x11</span>, <span class="number">0x41</span>, <span class="number">0x4F</span>, <span class="number">0x67</span>, <span class="number">0xDC</span>, <span class="number">0xEA</span>, <span class="number">0x97</span>, <span class="number">0xF2</span>, <span class="number">0xCF</span>, <span class="number">0xCE</span>, <span class="number">0xF0</span>, <span class="number">0xB4</span>, <span class="number">0xE6</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x96</span>, <span class="number">0xAC</span>, <span class="number">0x74</span>, <span class="number">0x22</span>, <span class="number">0xE7</span>, <span class="number">0xAD</span>, <span class="number">0x35</span>, <span class="number">0x85</span>, <span class="number">0xE2</span>, <span class="number">0xF9</span>, <span class="number">0x37</span>, <span class="number">0xE8</span>, <span class="number">0x1C</span>, <span class="number">0x75</span>, <span class="number">0xDF</span>, <span class="number">0x6E</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0xF1</span>, <span class="number">0x1A</span>, <span class="number">0x71</span>, <span class="number">0x1D</span>, <span class="number">0x29</span>, <span class="number">0xC5</span>, <span class="number">0x89</span>, <span class="number">0x6F</span>, <span class="number">0xB7</span>, <span class="number">0x62</span>, <span class="number">0x0E</span>, <span class="number">0xAA</span>, <span class="number">0x18</span>, <span class="number">0xBE</span>, <span class="number">0x1B</span>,</span><br><span class="line">    <span class="number">0xFC</span>, <span class="number">0x56</span>, <span class="number">0x3E</span>, <span class="number">0x4B</span>, <span class="number">0xC6</span>, <span class="number">0xD2</span>, <span class="number">0x79</span>, <span class="number">0x20</span>, <span class="number">0x9A</span>, <span class="number">0xDB</span>, <span class="number">0xC0</span>, <span class="number">0xFE</span>, <span class="number">0x78</span>, <span class="number">0xCD</span>, <span class="number">0x5A</span>, <span class="number">0xF4</span>,</span><br><span class="line">    <span class="number">0x1F</span>, <span class="number">0xDD</span>, <span class="number">0xA8</span>, <span class="number">0x33</span>, <span class="number">0x88</span>, <span class="number">0x07</span>, <span class="number">0xC7</span>, <span class="number">0x31</span>, <span class="number">0xB1</span>, <span class="number">0x12</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0x27</span>, <span class="number">0x80</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x7F</span>, <span class="number">0xA9</span>, <span class="number">0x19</span>, <span class="number">0xB5</span>, <span class="number">0x4A</span>, <span class="number">0x0D</span>, <span class="number">0x2D</span>, <span class="number">0xE5</span>, <span class="number">0x7A</span>, <span class="number">0x9F</span>, <span class="number">0x93</span>, <span class="number">0xC9</span>, <span class="number">0x9C</span>, <span class="number">0xEF</span>,</span><br><span class="line">    <span class="number">0xA0</span>, <span class="number">0xE0</span>, <span class="number">0x3B</span>, <span class="number">0x4D</span>, <span class="number">0xAE</span>, <span class="number">0x2A</span>, <span class="number">0xF5</span>, <span class="number">0xB0</span>, <span class="number">0xC8</span>, <span class="number">0xEB</span>, <span class="number">0xBB</span>, <span class="number">0x3C</span>, <span class="number">0x83</span>, <span class="number">0x53</span>, <span class="number">0x99</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0x2B</span>, <span class="number">0x04</span>, <span class="number">0x7E</span>, <span class="number">0xBA</span>, <span class="number">0x77</span>, <span class="number">0xD6</span>, <span class="number">0x26</span>, <span class="number">0xE1</span>, <span class="number">0x69</span>, <span class="number">0x14</span>, <span class="number">0x63</span>, <span class="number">0x55</span>, <span class="number">0x21</span>, <span class="number">0x0C</span>, <span class="number">0x7D</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">state = [</span><br><span class="line">    [<span class="number">251</span>, <span class="number">64</span>, <span class="number">182</span>, <span class="number">81</span>],</span><br><span class="line">    [<span class="number">146</span>, <span class="number">168</span>, <span class="number">33</span>, <span class="number">80</span>],</span><br><span class="line">    [<span class="number">199</span>, <span class="number">159</span>, <span class="number">195</span>, <span class="number">24</span>],</span><br><span class="line">    [<span class="number">64</span>, <span class="number">80</span>, <span class="number">182</span>, <span class="number">255</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub_bytes</span>(<span class="params">s, sbox=s_box</span>):</span><br><span class="line">    new_state = [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            pos = s[i][j]</span><br><span class="line">            row = pos &gt;&gt; <span class="number">4</span></span><br><span class="line">            col = pos - (row &lt;&lt; <span class="number">4</span>)</span><br><span class="line">            new_state[i][j] = inv_s_box[row * <span class="number">16</span> + col]</span><br><span class="line">    <span class="keyword">return</span> new_state</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(matrix2bytes(sub_bytes(state, sbox=inv_s_box)))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;l1n34rly&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Diffusion-through-Permutation"><a href="#Diffusion-through-Permutation" class="headerlink" title="Diffusion through Permutation"></a>Diffusion through Permutation</h4><p>我们已经看到S盒替代是如何造成混淆的。Shannon描述的另一个关键性质是“扩散”。这与输入密码的每个部分如何传播到输出的每个部分有关。<br>替代本身会产生非线性，但它不会将其分布在整个状态矩阵上。如果没有扩散，同一位置的同一字节在每一轮都会得到相同的转换。这将允许密码分析员分别攻击状态矩阵中的每个字节位置。我们需要通过对状态矩阵进行置乱（以可逆的方式）来交替替换，以便对一个字节应用的替换会影响状态矩阵中的所有其他字节。然后，下一个S盒的每个输入都变成了多个字节的函数，这意味着随着每一轮的进行，系统的代数复杂性都会大大增加。</p>
<blockquote>
<p>理想的扩散量会导致明文中一比特位的变化，从而导致密文中一半比特位的统计变化。这一理想的结果被称为<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Avalanche_effect">雪崩效应</a>。</p>
</blockquote>
<p><em>行移位</em>和<em>列混淆</em>步骤相结合可以实现这一点。它们协同工作，确保每个字节在两轮内影响状态矩阵中的其他每个字节。</p>
<p><em>行移位</em>是AES中最简单的转换。它使状态矩阵的第一行保持不变。第二行环绕向左移动一列。第三行移动了两列，第四行移动了三列。维基百科说得很好：“这一步的重要性是避免独立加密列，在这种情况下，AES会退化为四个独立的分组密码。”</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241108140107685.png" alt="image-20241108140107685"></p>
<blockquote>
<p>该图（和AES规范）显示了以列主符号表示的<code>行移位</code>操作。然而，下面的示例代码使用行主符号表示状态矩阵，因为它在Python中更自然。只要每次访问矩阵时使用相同的符号，最终结果就是相同的。由于访问模式和缓存行为，使用一种符号可以带来更好的性能。</p>
</blockquote>
<p><em>列混淆</em>更复杂。它在Rijndael的伽罗瓦域中在状态矩阵的列和预设矩阵之间执行矩阵乘法。因此，每列的每个字节都会影响结果列的所有字节。实施细节细致入微；<a target="_blank" rel="noopener" href="https://www.samiam.org/mix-column.html">这个页面</a>和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Rijndael_MixColumns">维基百科</a>很好地覆盖了它们。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241108140347816.png" alt="image-20241108140347816"></p>
<p>题目：我们提供了执行列混淆和正向行移位操作的代码。实现<code>inv_shift_rows</code>后，获取状态矩阵，在其上运行<code>inv_mix_columns</code>、<code>inv_shift_rows</code>，然后转换为字节，您将得到您的flag。</p>
<p>EXP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> matrix:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            message += <span class="built_in">str</span>(<span class="built_in">hex</span>(i[j])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(message, <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>] = s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>] = s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>] = s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c</span></span><br><span class="line">xtime = <span class="keyword">lambda</span> a: (((a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1B</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">if</span> (a &amp; <span class="number">0x80</span>) <span class="keyword">else</span> (a &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_single_column</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.2 in The Design of Rijndael</span></span><br><span class="line">    t = a[<span class="number">0</span>] ^ a[<span class="number">1</span>] ^ a[<span class="number">2</span>] ^ a[<span class="number">3</span>]</span><br><span class="line">    u = a[<span class="number">0</span>]</span><br><span class="line">    a[<span class="number">0</span>] ^= t ^ xtime(a[<span class="number">0</span>] ^ a[<span class="number">1</span>])</span><br><span class="line">    a[<span class="number">1</span>] ^= t ^ xtime(a[<span class="number">1</span>] ^ a[<span class="number">2</span>])</span><br><span class="line">    a[<span class="number">2</span>] ^= t ^ xtime(a[<span class="number">2</span>] ^ a[<span class="number">3</span>])</span><br><span class="line">    a[<span class="number">3</span>] ^= t ^ xtime(a[<span class="number">3</span>] ^ u)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        mix_single_column(s[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.3 in The Design of Rijndael</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        u = xtime(xtime(s[i][<span class="number">0</span>] ^ s[i][<span class="number">2</span>]))</span><br><span class="line">        v = xtime(xtime(s[i][<span class="number">1</span>] ^ s[i][<span class="number">3</span>]))</span><br><span class="line">        s[i][<span class="number">0</span>] ^= u</span><br><span class="line">        s[i][<span class="number">1</span>] ^= v</span><br><span class="line">        s[i][<span class="number">2</span>] ^= u</span><br><span class="line">        s[i][<span class="number">3</span>] ^= v</span><br><span class="line"></span><br><span class="line">    mix_columns(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">state = [</span><br><span class="line">    [<span class="number">108</span>, <span class="number">106</span>, <span class="number">71</span>, <span class="number">86</span>],</span><br><span class="line">    [<span class="number">96</span>, <span class="number">62</span>, <span class="number">38</span>, <span class="number">72</span>],</span><br><span class="line">    [<span class="number">42</span>, <span class="number">184</span>, <span class="number">92</span>, <span class="number">209</span>],</span><br><span class="line">    [<span class="number">94</span>, <span class="number">79</span>, <span class="number">8</span>, <span class="number">54</span>],</span><br><span class="line">]</span><br><span class="line">inv_mix_columns(state)</span><br><span class="line">inv_shift_rows(state)</span><br><span class="line"><span class="built_in">print</span>(matrix2bytes(state))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;d1ffUs3R&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Bringing-It-All-Together"><a href="#Bringing-It-All-Together" class="headerlink" title="Bringing It All Together"></a>Bringing It All Together</h4><p>除了<strong>KeyExpansion</strong>阶段，我们还概述了AES的所有部分。我们已经展示了<em>SubBytes</em>如何提供混淆，<em>ShiftRows</em>和<em>MixColumns</em>如何提供扩散，以及这两个属性如何协同工作，在状态矩阵上反复循环非线性转换。最后，<em>AddRoundKey</em>将密钥种子放入这个替换置换网络中，使密码成为密钥置换。</p>
<p>解密涉及反向执行“AES结构”挑战中描述的步骤，应用反向操作。请注意，仍然需要先运行KeyExpansion，并且将以相反的顺序使用轮密钥。由于XOR具有自逆特性，所以<em>AddRoundKey</em>及其逆是相同的。</p>
<p>题目：我们提供了KeyExpansion的代码，以及由AES-128正确加密的密文。复制到目前为止您编写的所有代码块，并完成实现图中所示步骤的<code>decrypt</code>函数。解密后的明文就是flag。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241115175249455.png" alt="image-20241115175249455"><br>这些练习中使用的代码取自Bo Zhu的超简单Python AES实现，因此我们在这里复制了许可证。</p>
<p>EXP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s_box = (</span><br><span class="line">    <span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>,</span><br><span class="line">    <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">    <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>,</span><br><span class="line">    <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>,</span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>,</span><br><span class="line">    <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>,</span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>,</span><br><span class="line">    <span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>,</span><br><span class="line">    <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>,</span><br><span class="line">    <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">    <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>,</span><br><span class="line">    <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>,</span><br><span class="line">    <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>,</span><br><span class="line">    <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">inv_s_box = (</span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x09</span>, <span class="number">0x6A</span>, <span class="number">0xD5</span>, <span class="number">0x30</span>, <span class="number">0x36</span>, <span class="number">0xA5</span>, <span class="number">0x38</span>, <span class="number">0xBF</span>, <span class="number">0x40</span>, <span class="number">0xA3</span>, <span class="number">0x9E</span>, <span class="number">0x81</span>, <span class="number">0xF3</span>, <span class="number">0xD7</span>, <span class="number">0xFB</span>,</span><br><span class="line">    <span class="number">0x7C</span>, <span class="number">0xE3</span>, <span class="number">0x39</span>, <span class="number">0x82</span>, <span class="number">0x9B</span>, <span class="number">0x2F</span>, <span class="number">0xFF</span>, <span class="number">0x87</span>, <span class="number">0x34</span>, <span class="number">0x8E</span>, <span class="number">0x43</span>, <span class="number">0x44</span>, <span class="number">0xC4</span>, <span class="number">0xDE</span>, <span class="number">0xE9</span>, <span class="number">0xCB</span>,</span><br><span class="line">    <span class="number">0x54</span>, <span class="number">0x7B</span>, <span class="number">0x94</span>, <span class="number">0x32</span>, <span class="number">0xA6</span>, <span class="number">0xC2</span>, <span class="number">0x23</span>, <span class="number">0x3D</span>, <span class="number">0xEE</span>, <span class="number">0x4C</span>, <span class="number">0x95</span>, <span class="number">0x0B</span>, <span class="number">0x42</span>, <span class="number">0xFA</span>, <span class="number">0xC3</span>, <span class="number">0x4E</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x2E</span>, <span class="number">0xA1</span>, <span class="number">0x66</span>, <span class="number">0x28</span>, <span class="number">0xD9</span>, <span class="number">0x24</span>, <span class="number">0xB2</span>, <span class="number">0x76</span>, <span class="number">0x5B</span>, <span class="number">0xA2</span>, <span class="number">0x49</span>, <span class="number">0x6D</span>, <span class="number">0x8B</span>, <span class="number">0xD1</span>, <span class="number">0x25</span>,</span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0xF8</span>, <span class="number">0xF6</span>, <span class="number">0x64</span>, <span class="number">0x86</span>, <span class="number">0x68</span>, <span class="number">0x98</span>, <span class="number">0x16</span>, <span class="number">0xD4</span>, <span class="number">0xA4</span>, <span class="number">0x5C</span>, <span class="number">0xCC</span>, <span class="number">0x5D</span>, <span class="number">0x65</span>, <span class="number">0xB6</span>, <span class="number">0x92</span>,</span><br><span class="line">    <span class="number">0x6C</span>, <span class="number">0x70</span>, <span class="number">0x48</span>, <span class="number">0x50</span>, <span class="number">0xFD</span>, <span class="number">0xED</span>, <span class="number">0xB9</span>, <span class="number">0xDA</span>, <span class="number">0x5E</span>, <span class="number">0x15</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0xA7</span>, <span class="number">0x8D</span>, <span class="number">0x9D</span>, <span class="number">0x84</span>,</span><br><span class="line">    <span class="number">0x90</span>, <span class="number">0xD8</span>, <span class="number">0xAB</span>, <span class="number">0x00</span>, <span class="number">0x8C</span>, <span class="number">0xBC</span>, <span class="number">0xD3</span>, <span class="number">0x0A</span>, <span class="number">0xF7</span>, <span class="number">0xE4</span>, <span class="number">0x58</span>, <span class="number">0x05</span>, <span class="number">0xB8</span>, <span class="number">0xB3</span>, <span class="number">0x45</span>, <span class="number">0x06</span>,</span><br><span class="line">    <span class="number">0xD0</span>, <span class="number">0x2C</span>, <span class="number">0x1E</span>, <span class="number">0x8F</span>, <span class="number">0xCA</span>, <span class="number">0x3F</span>, <span class="number">0x0F</span>, <span class="number">0x02</span>, <span class="number">0xC1</span>, <span class="number">0xAF</span>, <span class="number">0xBD</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x13</span>, <span class="number">0x8A</span>, <span class="number">0x6B</span>,</span><br><span class="line">    <span class="number">0x3A</span>, <span class="number">0x91</span>, <span class="number">0x11</span>, <span class="number">0x41</span>, <span class="number">0x4F</span>, <span class="number">0x67</span>, <span class="number">0xDC</span>, <span class="number">0xEA</span>, <span class="number">0x97</span>, <span class="number">0xF2</span>, <span class="number">0xCF</span>, <span class="number">0xCE</span>, <span class="number">0xF0</span>, <span class="number">0xB4</span>, <span class="number">0xE6</span>, <span class="number">0x73</span>,</span><br><span class="line">    <span class="number">0x96</span>, <span class="number">0xAC</span>, <span class="number">0x74</span>, <span class="number">0x22</span>, <span class="number">0xE7</span>, <span class="number">0xAD</span>, <span class="number">0x35</span>, <span class="number">0x85</span>, <span class="number">0xE2</span>, <span class="number">0xF9</span>, <span class="number">0x37</span>, <span class="number">0xE8</span>, <span class="number">0x1C</span>, <span class="number">0x75</span>, <span class="number">0xDF</span>, <span class="number">0x6E</span>,</span><br><span class="line">    <span class="number">0x47</span>, <span class="number">0xF1</span>, <span class="number">0x1A</span>, <span class="number">0x71</span>, <span class="number">0x1D</span>, <span class="number">0x29</span>, <span class="number">0xC5</span>, <span class="number">0x89</span>, <span class="number">0x6F</span>, <span class="number">0xB7</span>, <span class="number">0x62</span>, <span class="number">0x0E</span>, <span class="number">0xAA</span>, <span class="number">0x18</span>, <span class="number">0xBE</span>, <span class="number">0x1B</span>,</span><br><span class="line">    <span class="number">0xFC</span>, <span class="number">0x56</span>, <span class="number">0x3E</span>, <span class="number">0x4B</span>, <span class="number">0xC6</span>, <span class="number">0xD2</span>, <span class="number">0x79</span>, <span class="number">0x20</span>, <span class="number">0x9A</span>, <span class="number">0xDB</span>, <span class="number">0xC0</span>, <span class="number">0xFE</span>, <span class="number">0x78</span>, <span class="number">0xCD</span>, <span class="number">0x5A</span>, <span class="number">0xF4</span>,</span><br><span class="line">    <span class="number">0x1F</span>, <span class="number">0xDD</span>, <span class="number">0xA8</span>, <span class="number">0x33</span>, <span class="number">0x88</span>, <span class="number">0x07</span>, <span class="number">0xC7</span>, <span class="number">0x31</span>, <span class="number">0xB1</span>, <span class="number">0x12</span>, <span class="number">0x10</span>, <span class="number">0x59</span>, <span class="number">0x27</span>, <span class="number">0x80</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>,</span><br><span class="line">    <span class="number">0x60</span>, <span class="number">0x51</span>, <span class="number">0x7F</span>, <span class="number">0xA9</span>, <span class="number">0x19</span>, <span class="number">0xB5</span>, <span class="number">0x4A</span>, <span class="number">0x0D</span>, <span class="number">0x2D</span>, <span class="number">0xE5</span>, <span class="number">0x7A</span>, <span class="number">0x9F</span>, <span class="number">0x93</span>, <span class="number">0xC9</span>, <span class="number">0x9C</span>, <span class="number">0xEF</span>,</span><br><span class="line">    <span class="number">0xA0</span>, <span class="number">0xE0</span>, <span class="number">0x3B</span>, <span class="number">0x4D</span>, <span class="number">0xAE</span>, <span class="number">0x2A</span>, <span class="number">0xF5</span>, <span class="number">0xB0</span>, <span class="number">0xC8</span>, <span class="number">0xEB</span>, <span class="number">0xBB</span>, <span class="number">0x3C</span>, <span class="number">0x83</span>, <span class="number">0x53</span>, <span class="number">0x99</span>, <span class="number">0x61</span>,</span><br><span class="line">    <span class="number">0x17</span>, <span class="number">0x2B</span>, <span class="number">0x04</span>, <span class="number">0x7E</span>, <span class="number">0xBA</span>, <span class="number">0x77</span>, <span class="number">0xD6</span>, <span class="number">0x26</span>, <span class="number">0xE1</span>, <span class="number">0x69</span>, <span class="number">0x14</span>, <span class="number">0x63</span>, <span class="number">0x55</span>, <span class="number">0x21</span>, <span class="number">0x0C</span>, <span class="number">0x7D</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes2matrix</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 16-byte array into a 4x4 matrix.  &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">list</span>(text[i:i+<span class="number">4</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(text), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix2bytes</span>(<span class="params">matrix</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Converts a 4x4 matrix into a 16-byte array.  &quot;&quot;&quot;</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> matrix:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            message += <span class="built_in">str</span>(<span class="built_in">hex</span>(i[j])[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> long_to_bytes(<span class="built_in">int</span>(message, <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_round_key</span>(<span class="params">s, k</span>):</span><br><span class="line">    new_state = [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            new_state[i][j] = s[i][j] ^ k[i][j]</span><br><span class="line">    <span class="keyword">return</span> new_state</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub_bytes</span>(<span class="params">s, sbox=s_box</span>):</span><br><span class="line">    new_state = [[<span class="number">0</span> <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)] <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            pos = s[i][j]</span><br><span class="line">            row = pos &gt;&gt; <span class="number">4</span></span><br><span class="line">            col = pos - (row &lt;&lt; <span class="number">4</span>)</span><br><span class="line">            new_state[i][j] = inv_s_box[row * <span class="number">16</span> + col]</span><br><span class="line">    <span class="keyword">return</span> new_state</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>] = s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>] = s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>] = s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_shift_rows</span>(<span class="params">s</span>):</span><br><span class="line">    s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>], s[<span class="number">0</span>][<span class="number">1</span>] = s[<span class="number">0</span>][<span class="number">1</span>], s[<span class="number">1</span>][<span class="number">1</span>], s[<span class="number">2</span>][<span class="number">1</span>], s[<span class="number">3</span>][<span class="number">1</span>]</span><br><span class="line">    s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>], s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>] = s[<span class="number">0</span>][<span class="number">2</span>], s[<span class="number">1</span>][<span class="number">2</span>], s[<span class="number">2</span>][<span class="number">2</span>], s[<span class="number">3</span>][<span class="number">2</span>]</span><br><span class="line">    s[<span class="number">3</span>][<span class="number">3</span>], s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>] = s[<span class="number">0</span>][<span class="number">3</span>], s[<span class="number">1</span>][<span class="number">3</span>], s[<span class="number">2</span>][<span class="number">3</span>], s[<span class="number">3</span>][<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c</span></span><br><span class="line">xtime = <span class="keyword">lambda</span> a: (((a &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1B</span>) &amp; <span class="number">0xFF</span>) <span class="keyword">if</span> (a &amp; <span class="number">0x80</span>) <span class="keyword">else</span> (a &lt;&lt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_single_column</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.2 in The Design of Rijndael</span></span><br><span class="line">    t = a[<span class="number">0</span>] ^ a[<span class="number">1</span>] ^ a[<span class="number">2</span>] ^ a[<span class="number">3</span>]</span><br><span class="line">    u = a[<span class="number">0</span>]</span><br><span class="line">    a[<span class="number">0</span>] ^= t ^ xtime(a[<span class="number">0</span>] ^ a[<span class="number">1</span>])</span><br><span class="line">    a[<span class="number">1</span>] ^= t ^ xtime(a[<span class="number">1</span>] ^ a[<span class="number">2</span>])</span><br><span class="line">    a[<span class="number">2</span>] ^= t ^ xtime(a[<span class="number">2</span>] ^ a[<span class="number">3</span>])</span><br><span class="line">    a[<span class="number">3</span>] ^= t ^ xtime(a[<span class="number">3</span>] ^ u)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        mix_single_column(s[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_mix_columns</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="comment"># see Sec 4.1.3 in The Design of Rijndael</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        u = xtime(xtime(s[i][<span class="number">0</span>] ^ s[i][<span class="number">2</span>]))</span><br><span class="line">        v = xtime(xtime(s[i][<span class="number">1</span>] ^ s[i][<span class="number">3</span>]))</span><br><span class="line">        s[i][<span class="number">0</span>] ^= u</span><br><span class="line">        s[i][<span class="number">1</span>] ^= v</span><br><span class="line">        s[i][<span class="number">2</span>] ^= u</span><br><span class="line">        s[i][<span class="number">3</span>] ^= v</span><br><span class="line"></span><br><span class="line">    mix_columns(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expand_key</span>(<span class="params">master_key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Expands and returns a list of key matrices for the given master_key.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants</span></span><br><span class="line">    r_con = (</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>,</span><br><span class="line">        <span class="number">0x80</span>, <span class="number">0x1B</span>, <span class="number">0x36</span>, <span class="number">0x6C</span>, <span class="number">0xD8</span>, <span class="number">0xAB</span>, <span class="number">0x4D</span>, <span class="number">0x9A</span>,</span><br><span class="line">        <span class="number">0x2F</span>, <span class="number">0x5E</span>, <span class="number">0xBC</span>, <span class="number">0x63</span>, <span class="number">0xC6</span>, <span class="number">0x97</span>, <span class="number">0x35</span>, <span class="number">0x6A</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0xB3</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0xEF</span>, <span class="number">0xC5</span>, <span class="number">0x91</span>, <span class="number">0x39</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize round keys with raw key material.</span></span><br><span class="line">    key_columns = bytes2matrix(master_key)</span><br><span class="line">    iteration_size = <span class="built_in">len</span>(master_key) // <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Each iteration has exactly as many columns as the key material.</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(key_columns) &lt; (N_ROUNDS + <span class="number">1</span>) * <span class="number">4</span>:</span><br><span class="line">        <span class="comment"># Copy previous word.</span></span><br><span class="line">        word = <span class="built_in">list</span>(key_columns[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform schedule_core once every &quot;row&quot;.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(key_columns) % iteration_size == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Circular shift.</span></span><br><span class="line">            word.append(word.pop(<span class="number">0</span>))</span><br><span class="line">            <span class="comment"># Map to S-BOX.</span></span><br><span class="line">            word = [s_box[b] <span class="keyword">for</span> b <span class="keyword">in</span> word]</span><br><span class="line">            <span class="comment"># XOR with first byte of R-CON, since the others bytes of R-CON are 0.</span></span><br><span class="line">            word[<span class="number">0</span>] ^= r_con[i]</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(master_key) == <span class="number">32</span> <span class="keyword">and</span> <span class="built_in">len</span>(key_columns) % iteration_size == <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># Run word through S-box in the fourth iteration when using a</span></span><br><span class="line">            <span class="comment"># 256-bit key.</span></span><br><span class="line">            word = [s_box[b] <span class="keyword">for</span> b <span class="keyword">in</span> word]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># XOR with equivalent word from previous iteration.</span></span><br><span class="line">        word = <span class="built_in">bytes</span>(i^j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(word, key_columns[-iteration_size]))</span><br><span class="line">        key_columns.append(word)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Group keywords in 4x4 byte matrices.</span></span><br><span class="line">    <span class="keyword">return</span> [key_columns[<span class="number">4</span>*i : <span class="number">4</span>*(i+<span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key_columns) // <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">key, ciphertext</span>):</span><br><span class="line">    round_keys = expand_key(key) <span class="comment"># Remember to start from the last round key and work backwards through them when decrypting</span></span><br><span class="line">    <span class="comment"># Convert ciphertext to state matrix</span></span><br><span class="line">    cipher = bytes2matrix(ciphertext)</span><br><span class="line">    <span class="comment"># Initial add round key step</span></span><br><span class="line">    <span class="comment"># 传入当前cipher状态和当前轮密钥</span></span><br><span class="line">    <span class="comment"># 因为N_ROUNDS = 10 倒序 取keys[10]</span></span><br><span class="line">    cipher = add_round_key(cipher, round_keys[<span class="number">10</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N_ROUNDS - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># 每一轮的解密 除了最后一轮</span></span><br><span class="line">        inv_shift_rows(cipher)</span><br><span class="line">        cipher = sub_bytes(cipher)</span><br><span class="line">        cipher = add_round_key(cipher, round_keys[i])</span><br><span class="line">        inv_mix_columns(cipher)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run final round (skips the InvMixColumns step)</span></span><br><span class="line">    inv_shift_rows(cipher)</span><br><span class="line">    cipher = sub_bytes(cipher)</span><br><span class="line">    cipher = add_round_key(cipher, round_keys[<span class="number">0</span>])</span><br><span class="line">    <span class="comment"># Convert state matrix to plaintext</span></span><br><span class="line">    plaintext = matrix2bytes(cipher)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line">N_ROUNDS = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;\xc3,\\\xa6\xb5\x80^\x0c\xdb\x8d\xa5z*\xb6\xfe\\&#x27;</span></span><br><span class="line">ciphertext = <span class="string">b&#x27;\xd1O\x14j\xa4+O\xb6\xa1\xc4\x08B)\x8f\x12\xdd&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(decrypt(key, ciphertext))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;MYAES128&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="SYMMETRIC-STARTER"><a href="#SYMMETRIC-STARTER" class="headerlink" title="SYMMETRIC STARTER"></a>SYMMETRIC STARTER</h3><p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116153012048.png" alt="image-20241116153012048"></p>
<h4 id="Modes-of-Operation-Starter"><a href="#Modes-of-Operation-Starter" class="headerlink" title="Modes of Operation Starter"></a>Modes of Operation Starter</h4><h5 id="hint"><a href="#hint" class="headerlink" title="hint"></a>hint</h5><p>前面的一组挑战展示了AES如何对单个数据块执行密钥置换。在实际中，我们需要加密比单个块长得多的消息。<em>操作模式</em>描述了如何在较长的消息上使用类似AES的密码。</p>
<p>如果使用不当，所有模式都有严重的弱点。这个挑战将带您进入网站的不同部分，在那里您可以与API交互并利用这些弱点。熟悉界面，并用它来拿下你的下一个flag！</p>
<h5 id="SOURCE"><a href="#SOURCE" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">KEY = ?</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/block_cipher_starter/decrypt/&lt;ciphertext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext</span>):</span><br><span class="line">    ciphertext = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = cipher.decrypt(ciphertext)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;plaintext&quot;</span>: decrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/block_cipher_starter/encrypt_flag/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_flag</span>():</span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">    encrypted = cipher.encrypt(FLAG.encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: encrypted.<span class="built_in">hex</span>()&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp"><a href="#WriteUp" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>由starter页点击ENCRYPT_FLAG()的SUBMIT按钮，在OUTPUT中得到json数据:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span><span class="string">&quot;0bf3da3fce245ce6bd6c9a9abaaef49945bbf20ec314ca38b341707c36bd00b9&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116141049287.png" alt="image-20241116141049287"></p>
<p>将OUTPUT中的ciphertext扔到DECRYPT(CIPHERTEXT)中，点击SUBMIT按钮，在json中得到解密后的hex值：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span><span class="string">&quot;63727970746f7b626c30636b5f633170683372355f3472335f663435375f217d&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116141713943.png" alt="image-20241116141713943"></p>
<p>再放入HEX ENCODER&#x2F;DECODER中，HEX转为TEXT得到flag。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116141804516.png" alt="image-20241116141804516"></p>
<h4 id="Passwords-as-Keys"><a href="#Passwords-as-Keys" class="headerlink" title="Passwords as Keys"></a>Passwords as Keys</h4><h5 id="hint-1"><a href="#hint-1" class="headerlink" title="hint"></a>hint</h5><p>对称密钥算法中的密钥必须是随机字节，而不是密码或其他可预测的数据。随机字节应使用加密安全的伪随机数生成器（CSPRNG）生成。如果密钥在任何方面都是可预测的，那么密码的安全级别就会降低，并且访问密文的攻击者可能会对其进行解密。</p>
<p>仅仅因为密钥看起来像是由随机字节组成的，并不意味着它一定是。在这种情况下，密钥是使用哈希函数从简单密码中导出的，这使得密文是可破解的。</p>
<p>对于此挑战，您可以将HTTP请求编写到端点，或者离线攻击密文。祝你好运！</p>
<h5 id="SOURCE-1"><a href="#SOURCE-1" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># /usr/share/dict/words from</span></span><br><span class="line"><span class="comment"># https://gist.githubusercontent.com/wchargin/8927565/raw/d9783627c731268fb2935a731a618aa8e95cf465/words</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/usr/share/dict/words&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    words = [w.strip() <span class="keyword">for</span> w <span class="keyword">in</span> f.readlines()]</span><br><span class="line">keyword = random.choice(words)</span><br><span class="line"></span><br><span class="line">KEY = hashlib.md5(keyword.encode()).digest()</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/passwords_as_keys/decrypt/&lt;ciphertext&gt;/&lt;password_hash&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext, password_hash</span>):</span><br><span class="line">    ciphertext = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">    key = <span class="built_in">bytes</span>.fromhex(password_hash)</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = cipher.decrypt(ciphertext)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;plaintext&quot;</span>: decrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/passwords_as_keys/encrypt_flag/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_flag</span>():</span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">    encrypted = cipher.encrypt(FLAG.encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: encrypted.<span class="built_in">hex</span>()&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-1"><a href="#WriteUp-1" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>同上题一样，通过ENCRYPT_FLAG()获得ciphertext的json数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span><span class="string">&quot;c92b7734070205bdf6c0087a751466ec13ae15e6f1bcdd3f3a535ec0f4bbae66&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过SOURCE提示得到密码本，本地调用网站函数来解密。</p>
<h5 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext, password_hash</span>):</span><br><span class="line">    ciphertext = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">    <span class="comment"># key = bytes.fromhex(password_hash)</span></span><br><span class="line">    key = password_hash</span><br><span class="line">    cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = cipher.decrypt(ciphertext)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;plaintext&quot;</span>: decrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相对路径读文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwd.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    words = [w.strip() <span class="keyword">for</span> w <span class="keyword">in</span> f.readlines()]</span><br><span class="line">c = <span class="string">&quot;c92b7734070205bdf6c0087a751466ec13ae15e6f1bcdd3f3a535ec0f4bbae66&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> words:</span><br><span class="line">    <span class="comment"># 对密码本的每个数据进行爆破</span></span><br><span class="line">    KEY = hashlib.md5(i.encode()).digest()</span><br><span class="line">    m = decrypt(c, KEY)</span><br><span class="line">    m = m[<span class="string">&quot;plaintext&quot;</span>]</span><br><span class="line">    m = <span class="built_in">bytes</span>.fromhex(m)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;crypto&#123;&quot;</span> <span class="keyword">in</span> m:</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;k3y5__r__n07__p455w0rdz?&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="BLOCK-CIPHERS-1"><a href="#BLOCK-CIPHERS-1" class="headerlink" title="BLOCK CIPHERS 1"></a>BLOCK CIPHERS 1</h3><h4 id="ECB-CBC-WTF"><a href="#ECB-CBC-WTF" class="headerlink" title="ECB CBC WTF"></a>ECB CBC WTF</h4><h5 id="hint-2"><a href="#hint-2" class="headerlink" title="hint"></a>hint</h5><p>在这里，您可以在CBC中加密，但只能在ECB中解密。这不应该是一个弱点，因为它们是不同的模式…对吗？</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116155954010.png" alt="image-20241116155954010"></p>
<h5 id="SOURCE-2"><a href="#SOURCE-2" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">KEY = ?</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/ecbcbcwtf/decrypt/&lt;ciphertext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">ciphertext</span>):</span><br><span class="line">    ciphertext = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted = cipher.decrypt(ciphertext)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;plaintext&quot;</span>: decrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/ecbcbcwtf/encrypt_flag/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_flag</span>():</span><br><span class="line">    iv = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_CBC, iv)</span><br><span class="line">    encrypted = cipher.encrypt(FLAG.encode())</span><br><span class="line">    ciphertext = iv.<span class="built_in">hex</span>() + encrypted.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: ciphertext&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-2"><a href="#WriteUp-2" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>同前几题，得到密文：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span><span class="string">&quot;f14003406962ed9760ac5af1a8423677f05c7b58f9f99d8301ab42a138018c419d0af6c6c0a6a526db3eb816e943b1c7&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;f94d8df428e4641b2f251edee28f483b743f743a243cbafaaa1f3aed475466b0eab960009bf41f6c66d5880e6708b2de&quot;</span></span><br><span class="line">c = <span class="built_in">bytes</span>.fromhex(c)</span><br><span class="line"><span class="comment"># iv</span></span><br><span class="line">c1 = <span class="built_in">hex</span>(bytes_to_long(c[<span class="number">0</span>:<span class="number">16</span>]))[<span class="number">2</span>:]</span><br><span class="line">c2 = <span class="built_in">hex</span>(bytes_to_long(c[<span class="number">16</span>:<span class="number">32</span>]))[<span class="number">2</span>:]</span><br><span class="line">c3 = <span class="built_in">hex</span>(bytes_to_long(c[<span class="number">32</span>:<span class="number">48</span>]))[<span class="number">2</span>:]</span><br><span class="line">a1 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecbcbcwtf/decrypt/<span class="subst">&#123;c2&#125;</span>&#x27;</span>)</span><br><span class="line">a2 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecbcbcwtf/decrypt/<span class="subst">&#123;c3&#125;</span>&#x27;</span>)</span><br><span class="line">m1 = a1.json()[<span class="string">&quot;plaintext&quot;</span>]</span><br><span class="line">m2 = a2.json()[<span class="string">&quot;plaintext&quot;</span>]</span><br><span class="line">m1 = <span class="built_in">int</span>(m1, <span class="number">16</span>) ^ <span class="built_in">int</span>(c1, <span class="number">16</span>)</span><br><span class="line">m2 = <span class="built_in">int</span>(m2, <span class="number">16</span>) ^ <span class="built_in">int</span>(c2, <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m1) + long_to_bytes(m2))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;3cb_5uck5_4v01d_17_!!!!!&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="ECB-ORACLE"><a href="#ECB-ORACLE" class="headerlink" title="ECB ORACLE"></a>ECB ORACLE</h4><h5 id="hint-3"><a href="#hint-3" class="headerlink" title="hint"></a>hint</h5><p>ECB是最简单的模式，每个明文块都完全独立加密。在这种情况下，您的输入将被添加到秘密flag之前并加密，仅此而已。我们甚至不提供解密功能。也许当你有一个“ECB的预言者”时，你就不需要填充预言了？</p>
<h5 id="SOURCE-3"><a href="#SOURCE-3" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line"></span><br><span class="line">KEY = ?</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/ecb_oracle/encrypt/&lt;plaintext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">plaintext</span>):</span><br><span class="line">    plaintext = <span class="built_in">bytes</span>.fromhex(plaintext)</span><br><span class="line"></span><br><span class="line">    padded = pad(plaintext + FLAG.encode(), <span class="number">16</span>)</span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        encrypted = cipher.encrypt(padded)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: encrypted.<span class="built_in">hex</span>()&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-3"><a href="#WriteUp-3" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>本题为一道典型的ECB加密解密问题，首先，我们既不知道明文也不知道密文，由题目所给的加密算法，先尝试得到加密块大小和flag长度(?是要求的明文，F是ECB模式填充的字节，p是已求出的明文)。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241116201256839.png" alt="image-20241116201256839"></p>
<p>先用一个字符”a”去encrypt返回32个字节的数据(64位16进制)，再依次用”aa”,”aaa”,…去encrypt，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">31</span>):</span><br><span class="line">    <span class="comment"># 0x61 a</span></span><br><span class="line">    m = i*<span class="string">&#x27;61&#x27;</span></span><br><span class="line">    result = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecb_oracle/encrypt/<span class="subst">&#123;m&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a = result.json()[<span class="string">&quot;ciphertext&quot;</span>]</span><br><span class="line">        <span class="built_in">print</span>(i, <span class="built_in">len</span>(a)//<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># 1 32</span></span><br><span class="line"><span class="comment"># 2 32</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 6 32</span></span><br><span class="line"><span class="comment"># 7 48</span></span><br><span class="line"><span class="comment"># 8 48</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 22 48</span></span><br><span class="line"><span class="comment"># 23 64</span></span><br><span class="line"><span class="comment"># 24 64</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 30 64</span></span><br></pre></td></tr></table></figure>

<p>可见6个”a”的时候返回32个字节的数据，7个”a”的时候返回48个字节的数据，22个”a”的时候返回64个字节的数据，23个”a”的时候返回48个字节的数据。所以<strong>块大小</strong>就是16字节（22-6)，<strong>明文（flag）大小</strong>就是26个字节（32-6）。接着<strong>暴力破解</strong>求明文。</p>
<blockquote>
<p>aaaaaaaaaaaaaaa? ??????????????? ?????????FFFFFFF</p>
<p>aaaaaaaaaaaaaa?? ??????????????? ????????FFFFFFFF</p>
<p>aaaaaaaaaaaaa??? ??????????????? ???????FFFFFFFFF</p>
<p>aaaaaaaaaaaa???? ??????????????? ?????FFFFFFFFFFF</p>
</blockquote>
<p><strong>求第一位：</strong></p>
<p>15个”a”时返回的前16个字节只有最后一个字节未知，可以暴力遍历出第一个字节，也就是用15*”a”+flag第一个字节的加密密文与暴力遍历的加密密文去匹配。<strong>2-15位同理。</strong></p>
<p><strong>16-26位：</strong></p>
<p>与上述方法同理。</p>
<blockquote>
<p>aaaaaaaaaaaaaaaa ppppppppppppppp? ??????????FFFFFF</p>
<p>aaaaaaaaaaaaaaap ppppppppppppppp? ?????????FFFFFFF</p>
<p>aaaaaaaaaaaaaapp ppppppppppppppp? ????????FFFFFFFF</p>
<p>aaaaaaaaaaaaappp ppppppppppppppp? ???????FFFFFFFFF</p>
<p>aaaaaaaaaaaapppp ppppppppppppppp? ??????FFFFFFFFFF</p>
</blockquote>
<h5 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">m = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    t = <span class="string">&#x27;61&#x27;</span> * (<span class="number">15</span> - i)</span><br><span class="line">    test_result = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecb_oracle/encrypt/<span class="subst">&#123;t&#125;</span>&#x27;</span>)</span><br><span class="line">    tr = test_result.json()[<span class="string">&quot;ciphertext&quot;</span>][:<span class="number">32</span>]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        t = <span class="string">&#x27;61&#x27;</span> * (<span class="number">15</span> - i) + m</span><br><span class="line">        t += <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line">        brute_result = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecb_oracle/encrypt/<span class="subst">&#123;t&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(brute_result)</span><br><span class="line">        br = brute_result.json()[<span class="string">&quot;ciphertext&quot;</span>][:<span class="number">32</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> tr == br:</span><br><span class="line">                m += <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># bytes.fromhex(m) = &#x27;crypto&#123;p3n6u1n5&#x27;</span></span><br><span class="line">m = <span class="string">&#x27;63727970746f7b70336e3675316e35&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    t = <span class="string">&#x27;61&#x27;</span> * (<span class="number">16</span> - i)</span><br><span class="line">    test_result = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecb_oracle/encrypt/<span class="subst">&#123;t&#125;</span>&#x27;</span>)</span><br><span class="line">    tr = test_result.json()[<span class="string">&quot;ciphertext&quot;</span>][<span class="number">32</span>:<span class="number">64</span>]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">        t = <span class="string">&#x27;61&#x27;</span> * (<span class="number">16</span> - i) + m</span><br><span class="line">        t += <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line">        brute_result = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/ecb_oracle/encrypt/<span class="subst">&#123;t&#125;</span>&#x27;</span>)</span><br><span class="line">        br = brute_result.json()[<span class="string">&quot;ciphertext&quot;</span>][<span class="number">32</span>:<span class="number">64</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> tr == br:</span><br><span class="line">                m += <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(m))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;p3n6u1n5_h473_3cb&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Flipping-Cookie"><a href="#Flipping-Cookie" class="headerlink" title="Flipping Cookie"></a>Flipping Cookie</h4><h5 id="hint-4"><a href="#hint-4" class="headerlink" title="hint"></a>hint</h5><p>你可以在我的网站上得到一个cookie，但它不会帮助你获得flag…我想。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241117101904528.png" alt="image-20241117101904528"></p>
<h5 id="SOURCE-4"><a href="#SOURCE-4" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line">KEY = ?</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/flipping_cookie/check_admin/&lt;cookie&gt;/&lt;iv&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_admin</span>(<span class="params">cookie, iv</span>):</span><br><span class="line">    cookie = <span class="built_in">bytes</span>.fromhex(cookie)</span><br><span class="line">    iv = <span class="built_in">bytes</span>.fromhex(iv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cipher = AES.new(KEY, AES.MODE_CBC, iv)</span><br><span class="line">        decrypted = cipher.decrypt(cookie)</span><br><span class="line">        unpadded = unpad(decrypted, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&quot;admin=True&quot;</span> <span class="keyword">in</span> unpadded.split(<span class="string">b&quot;;&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;flag&quot;</span>: FLAG&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Only admin can read the flag&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/flipping_cookie/get_cookie/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookie</span>():</span><br><span class="line">    expires_at = (datetime.today() + timedelta(days=<span class="number">1</span>)).strftime(<span class="string">&quot;%s&quot;</span>)</span><br><span class="line">    cookie = <span class="string">f&quot;admin=False;expiry=<span class="subst">&#123;expires_at&#125;</span>&quot;</span>.encode()</span><br><span class="line"></span><br><span class="line">    iv = os.urandom(<span class="number">16</span>)</span><br><span class="line">    padded = pad(cookie, <span class="number">16</span>)</span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_CBC, iv)</span><br><span class="line">    encrypted = cipher.encrypt(padded)</span><br><span class="line">    ciphertext = iv.<span class="built_in">hex</span>() + encrypted.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;cookie&quot;</span>: ciphertext&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-4"><a href="#WriteUp-4" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>这是一道典型的CBC字节反转攻击。</p>
<p><img src="https://gitee.com/Q1uJu/picture_bed/raw/master/image-20241117102006026.png" alt="image-20241117102006026"></p>
<p>题目给出了两个函数<code>check_admin(cookie, iv)</code>和<code>get_cookie()</code>。</p>
<p>第一个函数将输入的<code>cookie</code>和<code>IV</code>进行<code>AES-BCB模式解密</code>，当解密得到的字符串满足以<code>;</code>为分割后存在<code>admin=True</code>的字符串的时候就会把flag输出出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">b&quot;admin=True&quot;</span> <span class="keyword">in</span> unpadded.split(<span class="string">b&quot;;&quot;</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;flag&quot;</span>: FLAG&#125;</span><br></pre></td></tr></table></figure>

<p>第二个函数会将 <code>cookie</code>这个字符串和一个<code>IV</code>经过<code>AES-BCB模式加密</code>后的结果同加密所用到的<code>IV</code>输出出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">expires_at = (datetime.today() + timedelta(days=<span class="number">1</span>)).strftime(<span class="string">&quot;%s&quot;</span>)</span><br><span class="line">cookie = <span class="string">f&quot;admin=False;expiry=<span class="subst">&#123;expires_at&#125;</span>&quot;</span>.encode()</span><br><span class="line"></span><br><span class="line">ciphertext = iv.<span class="built_in">hex</span>() + encrypted.<span class="built_in">hex</span>()</span><br><span class="line"><span class="keyword">return</span> &#123;<span class="string">&quot;cookie&quot;</span>: ciphertext&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过构造新的<code>IV</code>同原来的密文进行解密从而更改解密后的内容最终拿到flag。<br>$$<br>IV⊕Old&#x3D;T\T⊕IV&#x3D;Old\T⊕(IV⊕New⊕Old)&#x3D;Old⊕Old⊕New&#x3D;New\IV_new&#x3D;IV⊕New⊕Old\<br>$$<br>由上面的推导式<br>$$<br>IV_new&#x3D;IV⊕New⊕Old<br>$$<br>所以可得EXP。</p>
<h5 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">result = requests.get(<span class="string">&#x27;http://aes.cryptohack.org/flipping_cookie/get_cookie&#x27;</span>)</span><br><span class="line">cookie = result.json()[<span class="string">&quot;cookie&quot;</span>]</span><br><span class="line">cookie_bytes = <span class="built_in">bytes</span>.fromhex(cookie)</span><br><span class="line">iv = cookie_bytes[:<span class="number">16</span>]</span><br><span class="line">iv_hex = <span class="built_in">hex</span>(bytes_to_long(iv))</span><br><span class="line">c = cookie_bytes[<span class="number">16</span>:]</span><br><span class="line">c = <span class="built_in">hex</span>(bytes_to_long(c))[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line">old = <span class="string">b&#x27;admin=False;expi&#x27;</span></span><br><span class="line">new = <span class="string">b&#x27;admin=True;00000&#x27;</span></span><br><span class="line">m1 = <span class="built_in">hex</span>(bytes_to_long(old))</span><br><span class="line">m2 = <span class="built_in">hex</span>(bytes_to_long(new))</span><br><span class="line">iv_new = <span class="built_in">int</span>(m1, <span class="number">16</span>) ^ <span class="built_in">int</span>(m2, <span class="number">16</span>) ^ <span class="built_in">int</span>(iv_hex, <span class="number">16</span>)</span><br><span class="line">iv_new = <span class="built_in">hex</span>(iv_new)[<span class="number">2</span>:]</span><br><span class="line">result2 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/flipping_cookie/check_admin/<span class="subst">&#123;c&#125;</span>/<span class="subst">&#123;iv_new&#125;</span>&#x27;</span>)</span><br><span class="line">flag = result2.json()[<span class="string">&quot;flag&quot;</span>]</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># crypto&#123;4u7h3n71c4710n_15_3553n714l&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="附"><a href="#附" class="headerlink" title="附"></a>附</h5><p>本题需要修改的内容刚好在第一组里，如果修改内容在其他组，如第二组，则需要构造新的第一组的密文，构造规则与推导式相同：<br>$$<br>新的密文&#x3D;前一组的密文⊕原来的明文⊕新的明文<br>$$<br>只不过可能会需要同时构造新的<code>IV</code>，使新的密文同新的<code>IV</code>解密结果同以前相同。</p>
<h4 id="Lazy-CBC"><a href="#Lazy-CBC" class="headerlink" title="Lazy CBC"></a>Lazy CBC</h4><h5 id="hint-5"><a href="#hint-5" class="headerlink" title="hint"></a>hint</h5><p>我只是一个懒惰的开发人员，希望我的CBC加密能够正常工作。这些关于初始化向量的讨论是什么？听起来并不重要。</p>
<h5 id="SOURCE-5"><a href="#SOURCE-5" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">KEY = ?</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/lazy_cbc/encrypt/&lt;plaintext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">plaintext</span>):</span><br><span class="line">    plaintext = <span class="built_in">bytes</span>.fromhex(plaintext)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(plaintext) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Data length must be multiple of 16&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_CBC, KEY)</span><br><span class="line">    encrypted = cipher.encrypt(plaintext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: encrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/lazy_cbc/get_flag/&lt;key&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">key</span>):</span><br><span class="line">    key = <span class="built_in">bytes</span>.fromhex(key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> key == KEY:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;plaintext&quot;</span>: FLAG.encode().<span class="built_in">hex</span>()&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;invalid key&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/lazy_cbc/receive/&lt;ciphertext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">ciphertext</span>):</span><br><span class="line">    ciphertext = <span class="built_in">bytes</span>.fromhex(ciphertext)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(ciphertext) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Data length must be multiple of 16&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    cipher = AES.new(KEY, AES.MODE_CBC, KEY)</span><br><span class="line">    decrypted = cipher.decrypt(ciphertext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decrypted.decode() <span class="comment"># ensure plaintext is valid ascii</span></span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid plaintext: &quot;</span> + decrypted.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="string">&quot;Your message has been received&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-5"><a href="#WriteUp-5" class="headerlink" title="WriteUp"></a>WriteUp</h5><p>CBC的生成思路如下：<br>$$<br>m_1&#x3D;decrypt(c_1)\oplus{IV}\m_2&#x3D;decrypt(c_2)\oplus{m_1}\m_3&#x3D;decrypt(c_3)\oplus{m_2}<br>$$<br>本题给出了密文的生成代码，密文的解密代码以及flag的获得代码，且密文明文都可以由自己设置，我们不妨设如下特殊情况<br>$$<br>c_2&#x3D;0,c_1&#x3D;c_3\m_1\oplus{m_3}&#x3D;decrypt(c_1)\oplus{IV}\oplus{decrypt(c_1)}\oplus{m_2}&#x3D;IV<br>$$<br>即可得到<code>IV</code>，在本题中，<code>IV</code>即为所求<code>KEY</code>。</p>
<h5 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># t1 = &#x27;61&#x27; * 48</span></span><br><span class="line"><span class="comment"># result1 = requests.get(f&#x27;http://aes.cryptohack.org/lazy_cbc/encrypt/&#123;t1&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># c = result1.json()[&quot;ciphertext&quot;]</span></span><br><span class="line"><span class="comment"># t2 = c[:32] + &#x27;0&#x27; * 32 + c[:32]</span></span><br><span class="line"><span class="comment"># result2 = requests.get(f&#x27;http://aes.cryptohack.org/lazy_cbc/receive/&#123;t2&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># m1 = result2.json()</span></span><br><span class="line"><span class="comment"># print(m1)</span></span><br><span class="line">m1 = <span class="string">&#x27;61616161616161616161616161616161a381f13463f0698d5b8c9bc4af21c08e8a67784df1eb484abc01811d2bfbacd7&#x27;</span></span><br><span class="line">key = <span class="built_in">hex</span>(<span class="built_in">int</span>(m1[:<span class="number">32</span>], <span class="number">16</span>) ^ <span class="built_in">int</span>(m1[<span class="number">64</span>:], <span class="number">16</span>))[<span class="number">2</span>:]</span><br><span class="line">result3 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/lazy_cbc/get_flag/<span class="subst">&#123;key&#125;</span>&#x27;</span>)</span><br><span class="line">m = result3.json()[<span class="string">&quot;plaintext&quot;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(m))</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;50m3_p30pl3_d0n7_7h1nk_IV_15_1mp0r74n7_?&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Triple-DES"><a href="#Triple-DES" class="headerlink" title="Triple DES"></a>Triple DES</h4><h5 id="hint-6"><a href="#hint-6" class="headerlink" title="hint"></a>hint</h5><p>数据加密标准(DES)是AES的前身，目前仍广泛应用于支付卡行业等一些发展缓慢的领域。这一挑战展示了DES的一个奇怪弱点，而安全分组密码不应该有这个弱点。</p>
<h5 id="SOURCE-6"><a href="#SOURCE-6" class="headerlink" title="SOURCE"></a>SOURCE</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES3</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"></span><br><span class="line">IV = os.urandom(<span class="number">8</span>)</span><br><span class="line">FLAG = ?</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="comment"># xor 2 bytestrings, repeating the 2nd one if necessary</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(x ^ y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b * (<span class="number">1</span> + <span class="built_in">len</span>(a) // <span class="built_in">len</span>(b))))</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/triple_des/encrypt/&lt;key&gt;/&lt;plaintext&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">key, plaintext</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        key = <span class="built_in">bytes</span>.fromhex(key)</span><br><span class="line">        plaintext = <span class="built_in">bytes</span>.fromhex(plaintext)</span><br><span class="line">        plaintext = xor(plaintext, IV)</span><br><span class="line"></span><br><span class="line">        cipher = DES3.new(key, DES3.MODE_ECB)</span><br><span class="line">        ciphertext = cipher.encrypt(plaintext)</span><br><span class="line">        ciphertext = xor(ciphertext, IV)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;ciphertext&quot;</span>: ciphertext.<span class="built_in">hex</span>()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@chal.route(<span class="params"><span class="string">&#x27;/triple_des/encrypt_flag/&lt;key&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_flag</span>(<span class="params">key</span>):</span><br><span class="line">    <span class="keyword">return</span> encrypt(key, pad(FLAG.encode(), <span class="number">8</span>).<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h5 id="WriteUp-6"><a href="#WriteUp-6" class="headerlink" title="WriteUp"></a>WriteUp</h5><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Weak_key#Weak_keys_in_DES">DES Weak key</a></p>
<p>DES有几个特定的弱密钥和半弱密钥，会使DES的加密模式和解密模式完全相同，本题给出了<code>encrypt_flag(key)</code>和<code>encrypt(key, plaintext)</code>两个函数，key使用弱密钥，得到flag的密文，然后用key和flag的密文再一次加密，由于使用了弱密钥，加密与解密一致，对flag的密文用同样的key再加密一次即为解密，得到明文。</p>
<h5 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">key1 = <span class="string">b&#x27;\xfe&#x27;</span> * <span class="number">8</span></span><br><span class="line">key2 = <span class="string">b&#x27;\x01&#x27;</span> * <span class="number">8</span></span><br><span class="line">key3 = <span class="string">b&#x27;\xe0&#x27;</span> * <span class="number">4</span> + <span class="string">b&#x27;\xf1&#x27;</span> * <span class="number">4</span></span><br><span class="line">key4 = <span class="string">b&#x27;\x1f&#x27;</span> * <span class="number">4</span> + <span class="string">b&#x27;\x0e&#x27;</span> * <span class="number">4</span></span><br><span class="line"></span><br><span class="line">key = key3 + key4</span><br><span class="line">result1 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/triple_des/encrypt_flag/<span class="subst">&#123;key.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">c = result1.json()[<span class="string">&quot;ciphertext&quot;</span>]</span><br><span class="line">result2 = requests.get(<span class="string">f&#x27;http://aes.cryptohack.org/triple_des/encrypt/<span class="subst">&#123;key.<span class="built_in">hex</span>()&#125;</span>/<span class="subst">&#123;c&#125;</span>&#x27;</span>)</span><br><span class="line">m = result2.json()[<span class="string">&quot;ciphertext&quot;</span>]</span><br><span class="line">flag = <span class="built_in">bytes</span>.fromhex(m)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># b&#x27;crypto&#123;n0t_4ll_k3ys_4r3_g00d_k3ys&#125;\x06\x06\x06\x06\x06\x06&#x27;</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://q1uju.cc">Q1uJu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://q1uju.cc/2024/11/17/SYMMETRIC_CIPHERS/">http://q1uju.cc/2024/11/17/SYMMETRIC_CIPHERS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/assets/background.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/assets/fac4.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Q1uJu</div><div class="author-info-description">Learning Record</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Q1uJu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Q1uJu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1613732401@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Cryptohack-SYMMETRIC-CIPHERS"><span class="toc-number">1.</span> <span class="toc-text">Cryptohack-SYMMETRIC CIPHERS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SYMMETRIC-CIPHERS"><span class="toc-number">1.1.</span> <span class="toc-text">SYMMETRIC CIPHERS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-AES-WORKS"><span class="toc-number">1.1.1.</span> <span class="toc-text">How AES WORKS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Keyed-Permutations"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">Keyed Permutations</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Resisting-Bruteforce"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Resisting Bruteforce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Structure-of-AES"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">Structure of AES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Round-Keys"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">Round Keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Confusion-through-Substitution"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">Confusion through Substitution</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Diffusion-through-Permutation"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">Diffusion through Permutation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bringing-It-All-Together"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">Bringing It All Together</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SYMMETRIC-STARTER"><span class="toc-number">1.1.2.</span> <span class="toc-text">SYMMETRIC STARTER</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Modes-of-Operation-Starter"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">Modes of Operation Starter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint"><span class="toc-number">1.1.2.1.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE"><span class="toc-number">1.1.2.1.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp"><span class="toc-number">1.1.2.1.3.</span> <span class="toc-text">WriteUp</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Passwords-as-Keys"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">Passwords as Keys</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-1"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-1"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-1"><span class="toc-number">1.1.2.2.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP"><span class="toc-number">1.1.2.2.4.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BLOCK-CIPHERS-1"><span class="toc-number">1.1.3.</span> <span class="toc-text">BLOCK CIPHERS 1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ECB-CBC-WTF"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">ECB CBC WTF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-2"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-2"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-2"><span class="toc-number">1.1.3.1.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-1"><span class="toc-number">1.1.3.1.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ECB-ORACLE"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">ECB ORACLE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-3"><span class="toc-number">1.1.3.2.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-3"><span class="toc-number">1.1.3.2.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-3"><span class="toc-number">1.1.3.2.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-2"><span class="toc-number">1.1.3.2.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flipping-Cookie"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">Flipping Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-4"><span class="toc-number">1.1.3.3.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-4"><span class="toc-number">1.1.3.3.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-4"><span class="toc-number">1.1.3.3.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-3"><span class="toc-number">1.1.3.3.4.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%84"><span class="toc-number">1.1.3.3.5.</span> <span class="toc-text">附</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lazy-CBC"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">Lazy CBC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-5"><span class="toc-number">1.1.3.4.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-5"><span class="toc-number">1.1.3.4.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-5"><span class="toc-number">1.1.3.4.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-4"><span class="toc-number">1.1.3.4.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Triple-DES"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">Triple DES</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hint-6"><span class="toc-number">1.1.3.5.1.</span> <span class="toc-text">hint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SOURCE-6"><span class="toc-number">1.1.3.5.2.</span> <span class="toc-text">SOURCE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WriteUp-6"><span class="toc-number">1.1.3.5.3.</span> <span class="toc-text">WriteUp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXP-5"><span class="toc-number">1.1.3.5.4.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/assets/footer.png);"><div id="footer-wrap"><div class="copyright">&copy;2024 By Q1uJu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">There will be fog lights in the mountains.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>